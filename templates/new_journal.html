{% extends 'base.html' %}

{% block title %}New Journal Entry{% endblock %}

{% block content %}
<div class="journal-editor">
    <div class="editor-container">
        <div class="typography-controls">
            <div class="control-box">
                <label for="fontSelect">Font:</label>
                <select id="fontSelect">
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="Verdana, sans-serif">Verdana</option>
                </select>
            </div>

            <div class="control-box">
                <label for="entryType">Entry Type:</label>
                <select id="entryType">
                    <option value="daily">Daily Reflection</option>
                    <option value="gratitude">Gratitude</option>
                    <option value="goals">Goals</option>
                    <option value="dream">Dream Journal</option>
                    <option value="freewrite">Free Write</option>
                </select>
            </div>

            <div class="control-box">
                <label for="moodSelect">Mood:</label>
                <select id="moodSelect">
                    <option value="happy">Happy</option>
                    <option value="sad">Sad</option>
                    <option value="excited">Excited</option>
                    <option value="relaxed">Relaxed</option>
                    <option value="anxious">Anxious</option>
                    <option value="productive">Productive</option>
                    <option value="creative">Creative</option>
                </select>
            </div>
            
            <div class="control-box">
                <label for="fontSize">Font Size:</label>
                <input type="number" id="fontSize" value="16" min="12" max="30" step="1">
            </div>

            <div class="control-box">
                <label for="lineHeight">Line Height:</label>
                <input type="number" id="lineHeight" value="1.5" min="1.0" max="2.0" step="0.1">
            </div>
        </div>

        <div id="characterCount" style="text-align: right; color: #777;">0 characters</div>

        <textarea id="journalText" placeholder="Start writing your journal entry here..." style="width: 100%; min-height: 300px; padding: 15px; border: 1px solid #ccc; border-radius: 5px;"></textarea>

        <div class="sketchpad-section">
            <h2>Sketch Pad</h2>
            <div class="sketchpad-controls-top">
                <div class="control-box">
                    <label for="penColor">Pen Color:</label>
                    <input type="color" id="penColor" value="#000000">
                </div>
                <div class="control-box">
                    <label for="penSize">Pen Size:</label>
                    <input type="range" id="penSize" min="1" max="10" value="2">
                    <span id="penSizeValue">2</span>
                </div>
            </div>
            <canvas id="sketchpad" width="600" height="400" style="border: 1px solid #000; background-color: #fff;"></canvas>
            <div class="sketchpad-controls-bottom">
                <button id="clearSketch">Clear</button>
                <button id="insertSketch">Insert Sketch into Journal</button>
                <button id="addStickerButton">Use as Sticker</button>
        <div id="stickerContainer" style="position: relative; width: 100%; min-height: 300px; margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
        <button id="saveButton">Save Journal</button>
    </div>
</div>

<script>
    const textarea = document.getElementById('journalText');
    const fontSelect = document.getElementById('fontSelect');
    const fontSizeInput = document.getElementById('fontSize');
    const lineHeightInput = document.getElementById('lineHeight');
    const saveButton = document.getElementById('saveButton');

    // Character Counter
    const characterCount = document.getElementById('characterCount');
    textarea.addEventListener('input', () => {
        characterCount.textContent = `${textarea.value.length} characters`;
    });

    fontSelect.addEventListener('change', () => {
        textarea.style.fontFamily = fontSelect.value;
    });

    fontSizeInput.addEventListener('input', () => {
        textarea.style.fontSize = fontSizeInput.value + 'px';
    });

    lineHeightInput.addEventListener('input', () => {
        textarea.style.lineHeight = lineHeightInput.value + 'px';
    });

    saveButton.addEventListener('click', () => {
      const journalText = textarea.value; // Now contains sketch placeholders
      const fontFamily = fontSelect.value;
      const fontSize = fontSizeInput.value + 'px';
      const lineHeight = lineHeightInput.value + 'px';
      const mood = document.getElementById('moodSelect').value;
      const entryType = document.getElementById('entryType').value;

      fetch('/journal/new/', { // Note: This route handles both GET and POST for new entry
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title: 'New Entry', // You might want to add a title input
          content: journalText, // Send the text with sketch placeholders
          fontFamily: fontFamily,
          fontSize: fontSize,
          lineHeight: lineHeight,
          mood: mood,
          type: entryType
         })
      })
      .then(response => response.json())
      .then(data => {
        if(data.status === 'success') {
          alert('Journal saved successfully!');
          window.location.href = "{{ url_for('dashboard') }}";
        } else {
          alert('Failed to save journal: ' + data.message);
        }
      })
      .catch(error => console.error('Error:', error));
    });

    // Sketchpad Functionality
    const sketchpad = document.getElementById('sketchpad');
    const ctx = sketchpad.getContext('2d');
    const penColor = document.getElementById('penColor');
    const penSize = document.getElementById('penSize');
    const penSizeValue = document.getElementById('penSizeValue');
    const clearSketch = document.getElementById('clearSketch');
    const insertSketchBtn = document.getElementById('insertSketch'); // Renamed button

    let isDrawing = false;
    ctx.lineWidth = penSize.value;
    ctx.strokeStyle = penColor.value;

    sketchpad.addEventListener('mousedown', (e) => {
        isDrawing = true;
        ctx.beginPath();
        const rect = sketchpad.getBoundingClientRect();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });

    sketchpad.addEventListener('mousemove', draw);
    sketchpad.addEventListener('mouseup', stopDrawing);
    sketchpad.addEventListener('mouseout', stopDrawing);

    function draw(e) {
        if (!isDrawing) return;
        const rect = sketchpad.getBoundingClientRect();
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
    }

    function stopDrawing() {
        isDrawing = false;
    }

    penColor.addEventListener('change', () => {
        ctx.strokeStyle = penColor.value;
    });

    penSize.addEventListener('input', () => {
        ctx.lineWidth = penSize.value;
        penSizeValue.textContent = penSize.value;
    });

    clearSketch.addEventListener('click', () => {
        ctx.clearRect(0, 0, sketchpad.width, sketchpad.height);
    });

    // New logic to insert sketch into textarea
    insertSketchBtn.addEventListener('click', () => {
        const sketchDataURL = sketchpad.toDataURL();
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;

        // Insert a unique placeholder for the sketch data
        const placeholder = `[SKETCH_DATA:${sketchDataURL}]`;
        textarea.value = text.substring(0, start) + placeholder + text.substring(end, text.length);

        ctx.clearRect(0, 0, sketchpad.width, sketchpad.height); // Clear sketchpad after inserting
        textarea.focus(); // Keep focus on textarea
        textarea.selectionEnd = start + placeholder.length; // Set cursor after inserted text
      });

  function addSticker() {
  const stickerContainer = document.getElementById('stickerContainer');
  const dataURL = sketchpad.toDataURL(); // <--- FIXED this line

  const wrapper = document.createElement('div');
    wrapper.className = 'sticker-wrapper';
    Object.assign(wrapper.style, {
      position: 'absolute',
      left: '0px',
      top: '0px',
      width: '100px',
      height: '100px',
      cursor: 'move',
      userSelect: 'none',
    });

    const img = document.createElement('img');
    img.src = dataURL;
    Object.assign(img.style, {
      width: '100%',
      height: '100%',
      display: 'block',
      pointerEvents: 'none',
    });

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'resize-handle';
    Object.assign(resizeHandle.style, {
      position: 'absolute',
      right: '0',
      bottom: '0',
      width: '12px',
      height: '12px',
      background: '#333',
      cursor: 'nwse-resize',
    });

    const rotateHandle = document.createElement('div');
    rotateHandle.className = 'rotate-handle';
    Object.assign(rotateHandle.style, {
      position: 'absolute',
      top: '-20px',
      left: '50%',
      transform: 'translateX(-50%)',
      width: '12px',
      height: '12px',
      background: '#555',
      cursor: 'grab',
      borderRadius: '50%',
    });

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-button';
    deleteBtn.innerHTML = 'Ã—';
    Object.assign(deleteBtn.style, {
      position: 'absolute',
      top: '-10px',
      right: '-10px',
      background: 'red',
      color: 'white',
      border: 'none',
      borderRadius: '50%',
      width: '20px',
      height: '20px',
      cursor: 'pointer',
    });
    deleteBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(img);
    wrapper.appendChild(resizeHandle);
    wrapper.appendChild(rotateHandle);
    wrapper.appendChild(deleteBtn);
    stickerContainer.appendChild(wrapper);

    // Dragging
    let isDragging = false, dragOffsetX, dragOffsetY;
    wrapper.addEventListener('mousedown', (e) => {
      if (![resizeHandle, rotateHandle, deleteBtn].includes(e.target)) {
        isDragging = true;
        dragOffsetX = e.offsetX;
        dragOffsetY = e.offsetY;
      }
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        wrapper.style.left = (e.pageX - stickerContainer.offsetLeft - dragOffsetX) + 'px';
        wrapper.style.top = (e.pageY - stickerContainer.offsetTop - dragOffsetY) + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      isResizing = false;
      isRotating = false;
    });


    // Resizing
    let isResizing = false, startX, startY, startWidth, startHeight;
    resizeHandle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      isResizing = true;
      startX = e.clientX;
      startY = e.clientY;
      startWidth = wrapper.offsetWidth;
      startHeight = wrapper.offsetHeight;
    });

    document.addEventListener('mousemove', (e) => {
      if (isResizing) {
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        wrapper.style.width = (startWidth + dx) + 'px';
        wrapper.style.height = (startHeight + dy) + 'px';
      }
    });

    // Rotating
    let isRotating = false;
    rotateHandle.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      isRotating = true;
      const rect = wrapper.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      function rotateMove(ev) {
        if (!isRotating) return;
        const angle = Math.atan2(ev.clientY - centerY, ev.clientX - centerX);
        wrapper.style.transform = `rotate(${angle}rad)`;
      }

      function stopRotate() {
        isRotating = false;
        document.removeEventListener('mousemove', rotateMove);
        document.removeEventListener('mouseup', stopRotate);
      }

      document.addEventListener('mousemove', rotateMove);
      document.addEventListener('mouseup', stopRotate);
    });
     
  }
document.getElementById('addStickerButton').addEventListener('click', addSticker);   

</script>
<style>
    /* Add/Keep your existing CSS for .sketchpad-section, .sketchpad-controls-top/bottom, #sketchpad */
    .sketchpad-section {
        margin-top: 30px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 8px;
        background-color: #fcfcfc;
    }
    .sketchpad-controls-top, .sketchpad-controls-bottom {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        align-items: center;
    }
    .sketchpad-controls-bottom {
        margin-top: 15px;
    }
    #sketchpad {
        display: block;
        margin: 0 auto;
        background-color: #fff;
    }
    /* Remove any .sticker or .sticker-container CSS as they are no longer used for dynamic placement */
</style>
{% endblock %}