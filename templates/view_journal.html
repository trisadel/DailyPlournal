{% extends 'base.html' %}

{% block title %}{{ entry.title }}{% endblock %}

{% block content %}
<div class="journal-editor">
    <div class="editor-container">
        <h1>{{ entry.title }}</h1>
        <p><strong>Type:</strong> {{ entry.type }}</p>
        <p><strong>Date Posted:</strong> {{ entry.date_posted.strftime('%Y-%m-%d %H:%M') }}</p>
        {% if entry.updated_at and entry.updated_at != entry.date_posted %}
            <p><strong>Last Updated:</strong> {{ entry.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% endif %}
        {% if entry.mood %}
            <p><strong>Mood:</strong> {{ entry.mood }}</p>
        {% endif %}
        <p><strong>Content:</strong></p>
        {# Use a hidden preformatted tag to preserve newlines and get the raw string #}
        <pre id="rawJournalContent" style="display:none;">{{ entry.content }}</pre>
        <div id="journalContentDisplay"></div>

        <div class="btn-field">
            <a href="{{ url_for('edit_journal_entry', entry_id=entry.id) }}" class="button">Edit</a>
            <a href="{{ url_for('delete_journal_entry', entry_id=entry.id) }}" class="dltbutton"
               onclick="return confirm('Are you sure you want to delete this entry?')">Delete</a>
            <a href="{{ url_for('dashboard') }}" class="button">Back to Dashboard</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const contentDisplayDiv = document.getElementById('journalContentDisplay');
        const rawContentPre = document.getElementById('rawJournalContent');
        let processedContent = rawContentPre.textContent; // Use textContent to get raw string

        // Extract and process sketch data
        processedContent = processedContent.replace(/\[SKETCH_DATA:({.*?})\]/g, (match, jsonString) => {
            try {
                const sketchData = JSON.parse(jsonString);
                const dataURL = sketchData.url;

                // Display sketch inside a wrapper or directly as an image
                return `<div class="sketch-display-area"><img src="${dataURL}" alt="Sketch" style="max-width:100%; height:auto; display:block;"></div><br>`;
            } catch (e) {
                console.error("Error parsing sketch JSON data:", e);
                return ''; // Return empty string if parsing fails
            }
        });

        // Convert remaining newlines to <br> tags for plain text
        // If content comes from <pre> tag's textContent, newlines will be literal \n
        processedContent = processedContent.replace(/\n/g, '<br>');

        contentDisplayDiv.innerHTML = processedContent;
    });
</script>
{% endblock %}