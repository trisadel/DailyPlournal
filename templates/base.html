<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}My Journal{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='journal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='musicplay_fixed.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer">
    {% block head %}
    {% endblock %}
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-logo">DailyPlournal</div>

        <div class="profile-section">
            <a href="{{ url_for('profile') }}" class="profile-link">
                <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_pic if user.profile_pic else 'default.png')) }}"
                     alt="Profile Picture" class="profile-pic"
                     style="width: 40px; height: 40px; border-radius: 9999px; border: 2px solid #6366F1; transition: 0.3s;"
                     onmouseover="this.style.boxShadow='0 0 0 3px #c7d2fe'" onmouseout="this.style.boxShadow='none'">
            </a>
            <input type="text" class="name-field" placeholder="{{ user.username }}" disabled>
            <div class="interactive-elements">
            </div>
            <div class="streak-counter">Current Streak: <span id="streakCount">{{ current_streak }}</span> days</div>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li><a href="{{ url_for('home') }}">Home</a></li>
                <li>
                    <a href="{{ url_for('dashboard') }}">Dashboard</a>
                </li>
                <li>
                    <a href="{{ url_for('new_journal_entry') }}" id="write-link">Write</a>
                </li>
                <li>
                        <a href="#">Journal Actions</a>
                        <div class="journal-actions-filters">
                        <input type="text" id="entrySearch" placeholder="Search entries...">
                        <input type="date" id="entryDateFilter">
                        </div>
                        <ul id="entryList">
                            {% if journal_entries %}
                                {% for entry in journal_entries %}
                                    <li>
                                        <a href="{{ url_for('view_journal_entry', entry_id=entry.id) }}"
                                        data-title="{{ entry.title | lower }}"
                                        data-date="{{ entry.date.strftime('%Y-%m-%d') }}"
                                            {{ entry.title }} ({{ entry.date.strftime('%Y-%m-%d') }})
                                        </a>
                                    </li>
                                {% endfor %}
                            {% else %}
                                <li>No entries yet</li>
                            {% endif %}
                        </ul>
                    </li>
                <li>
                    <a href="{{ url_for('planner') }}">Planner</a>
                </li>
                <li><a href="{{ url_for('logout') }}">Log Out</a></li>
            </ul>
        </nav>
    </div>

    <button class="toggle-btn">â˜°</button>

    <div class="content">
        {% block content %}
        {% endblock %}
    </div>

    <div class="music-player-fixed" id="musicPlayerFixed">
        <div class="music-player-fixed-header">
            <div class="drag-handle"><i class="fas fa-bars"></i></div>
            <h1>ðŸŒŒ Pulse & Pause </h1>
        </div>
        <div>
            <label for="fixed_playlist">Choose a vibe:</label>
            <select id="fixed_playlist">
                <option value="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M">POP hits rn!!</option>
                <option value="https://open.spotify.com/embed/playlist/5UFZXhJk7w4joCfg6jS0GV">R&B</option>
                <option value="https://open.spotify.com/embed/playlist/37i9dQZF1DWSluGMsH1R9r">Lo-Fi Beats</option>
                <option value="https://open.spotify.com/embed/playlist/37i9dQZF1DX9sIqqvKsjG8">Deep Focus</option>
            </select>
            <button id="fixed_themeToggle">ðŸŒ“ Toggle Theme</button>
        </div>
        <iframe id="fixed_spotifyEmbed"
                src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M"
                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                loading="lazy">
        </iframe>
    </div>
    <div class="background" id="fixedStarsContainer"></div>

    {% block scripts %}
    <script>
        const musicPlayerFixed = document.getElementById("musicPlayerFixed");
        const fixedEmbed = document.getElementById("fixed_spotifyEmbed");
        const fixedSelect = document.getElementById("fixed_playlist");
        const fixedToggle = document.getElementById("fixed_themeToggle");
        const body = document.body;
        const fixedStarsContainer = document.getElementById("fixedStarsContainer");
        const dragHandle = document.querySelector('.drag-handle'); // Get the drag handle

        let isDragging = false;
        let offsetX, offsetY;

        dragHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            musicPlayerFixed.classList.add('dragging');
            offsetX = e.clientX - musicPlayerFixed.getBoundingClientRect().left;
            offsetY = e.clientY - musicPlayerFixed.getBoundingClientRect().top;
            e.stopPropagation(); // Prevent immediate expansion when starting drag
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            musicPlayerFixed.style.left = e.clientX - offsetX + 'px';
            musicPlayerFixed.style.top = e.clientY - offsetY + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            musicPlayerFixed.classList.remove('dragging');
        });

        musicPlayerFixed.addEventListener("click", () => {
            musicPlayerFixed.classList.toggle("expanded");
        });

        fixedSelect.addEventListener("change", () => {
            fixedEmbed.src = fixedSelect.value;
            const selectedVibe = fixedSelect.options[fixedSelect.selectedIndex].text;
            alert(`Switched to: ${selectedVibe}`);
        });

        fixedToggle.addEventListener("click", () => {
            body.classList.toggle("light-mode");
        });

        for (let i = 0; i < 50; i++) {
            const star = document.createElement("div");
            star.className = "stars";
            star.style.top = Math.random() * 100 + "%";
            star.style.left = Math.random() * 100 + "%";
            star.style.animationDuration = (Math.random() * 2 + 1) + "s";
            fixedStarsContainer.appendChild(star);
        }

        // Keep existing scripts block for page-specific scripts
        const sidebar = document.querySelector('.sidebar');
        const content = document.querySelector('.content');
        const toggleBtn = document.querySelector('.toggle-btn');

        toggleBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
        });

        // --- Journal entry filter logic ---
    const searchInput = document.getElementById("entrySearch");
    const dateFilter = document.getElementById("entryDateFilter");
    const entryList = document.getElementById("entryList");

    function filterEntries() {
        const searchText = searchInput.value.toLowerCase();
        const filterDate = dateFilter.value;

        Array.from(entryList.getElementsByTagName("li")).forEach((li) => {
            const link = li.querySelector("a");
            if (!link) return;

            const title = link.dataset.title || "";
            const date = link.dataset.date || "";

            const matchesTitle = title.includes(searchText);
            const matchesDate = !filterDate || date === filterDate;

            li.style.display = matchesTitle && matchesDate ? "" : "none";
        });
    }

    searchInput.addEventListener("input", filterEntries);
    dateFilter.addEventListener("input", filterEntries);

    </script>
    {% endblock %}
</body>

</html>